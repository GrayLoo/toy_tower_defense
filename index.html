<html>


<script src="src/createjs.min.js"></script>
<script src="src/path_planner.js"></script>

<body onload="init();">
    <canvas id="main_stage" width="800" height="600"></canvas>
</body>

<script>
    var config = {
        weapons: {
            laser_gun: {
                price: 100,
                damage: 10,
                range: 3,
            }
        },
        map: {
            resolution: 25,
            width: 500,
            height: 500,
            padding_x: 50,
            padding_y: 50,
        },
        panel: {
            width: 100,
            height: 500,
        },
    };

    function grid_to_pixel(grid_x, grid_y) {
        var px = config.map.padding_x + (grid_x + 0.5) * config.map.resolution
        var py = config.map.padding_y + (grid_y + 0.5) * config.map.resolution
        return { x: Math.floor(px), y: Math.floor(py) };
    }

    function pixel_to_grid(px, py) {
        var gx = (px - config.map.padding_x) / config.map.resolution - 0.5
        var gy = (py - config.map.padding_y) / config.map.resolution - 0.5
        return { x: Math.floor(gx), y: Math.floor(gy) };
    }

    class Barrier {
        constructor(gx, gy) {
            this.gx = gx;
            this.gy = gy;
            var pixel = grid_to_pixel(this.gx, this.gy);
            this.px = pixel.x;
            this.py = pixel.y;
            this.shape = new createjs.Shape();
            this.shape.graphics.beginFill("rgba(0, 0, 0, 0.9)").drawCircle(0, 0, config.map.resolution * 0.5 - 1);
            this.shape.x = this.px;
            this.shape.y = this.py;
        }
    }

    class LaserGun {
        constructor(gx, gy) {
            this.gx = gx;
            this.gy = gy;
            var pixel = grid_to_pixel(this.gx, this.gy);
            this.px = pixel.x;
            this.py = pixel.y;
            this.shape = new createjs.Shape();
            this.shape.graphics.beginFill("rgba(255, 0, 0, 0.9)").drawCircle(0, 0, config.map.resolution * 0.5 - 1);
            this.shape.x = this.px;
            this.shape.y = this.py;
            this.damage = config.weapons.laser_gun.damage;
            this.range = config.weapons.laser_gun.range;
        }
    }

    class Panel {
        constructor(stage) {
            this.stage = stage;
            var vertical_line = new createjs.Shape();
            this.stage.addChild(vertical_line);
            vertical_line.graphics.setStrokeStyle(1).beginStroke("rgba(127, 127, 127, 0.5)")

            var start_x = config.map.padding_x + config.map.width + 25;
            var start_y = config.map.padding_y;
            vertical_line.graphics.moveTo(start_x, start_y);

            var end_x = start_x;
            var end_y = config.map.padding_y + config.map.height;
            vertical_line.graphics.lineTo(end_x, end_y);
            vertical_line.graphics.endStroke();
        }
    }

    class Monster {
        constructor(start_gx, start_gy, dest_gx, dest_gy, grid_map) {
            this.start_gx = start_gx;
            this.start_gy = start_gy;

            this.dest_gx = dest_gx;
            this.dest_gy = dest_gy;

            this.grid_map = grid_map;

            this.dest_px = Math.floor(config.map.padding_x + config.map.width + 0.5 * config.map.resolution);
            this.dest_py = Math.floor(config.map.padding_y + config.map.height + 0.5 * config.map.resolution);

            this.current_gx = this.start_gx;
            this.current_gy = this.start_gy;

            var pixel = grid_to_pixel(this.current_gx, this.current_gy);
            this.current_px = pixel.x;
            this.current_py = pixel.y;

            // pixel/time step
            this.speed = 0.5
            this.displacement = 0.0
            this.path = []

            this.shape = new createjs.Shape();
            this.shape.graphics.beginFill("rgba(0, 255, 255, 0.8").drawCircle(0, 0, config.map.resolution * 0.5 - 1);
            this.shape.x = pixel.x;
            this.shape.y = pixel.y;

            this.compute_path()
        }

        move() {
            this.displacement += this.speed;

            if (this.displacement < 1.0) {
                return;
            }

            for (var i = 0; i < this.displacement; ++i) {
                this.path.pop();
            }
            this.displacement = 0.0;

            var current_dest = this.path.pop();
            if (current_dest == undefined) {
                return;
            }
            this.shape.x = current_dest.x;
            this.shape.y = current_dest.y;
        }

        compute_path() {
        }
    }

    class GridMap {
        constructor(stage) {
            this.stage = stage;

            this.resolution = config.map.resolution;
            this.height = config.map.height;
            this.width = config.map.width;

            this.x_n_grids = this.width / this.resolution;
            this.y_n_grids = this.height / this.resolution;

            this.grids = []

            this.barriers = [];
            this.weapons = []
            this.monsters = []

            this.padding_x = config.map.padding_x;
            this.padding_y = config.map.padding_y;

            this.initialize_map()
        }

        initialize_map() {
            // draw grids
            for (var row = 0; row < this.y_n_grids + 1; ++row) {
                var line = new createjs.Shape();
                this.stage.addChild(line);
                line.graphics.setStrokeStyle(1).beginStroke("rgba(0, 0, 0, 0.5)")

                var start_x = this.padding_x;
                var start_y = this.padding_y + this.resolution * row;
                line.graphics.moveTo(start_x, start_y);

                var end_x = this.padding_x + this.width;
                var end_y = start_y;
                line.graphics.lineTo(end_x, end_y);
                line.graphics.endStroke();
            }
            for (var col = 0; col < this.x_n_grids + 1; ++col) {
                var line = new createjs.Shape();
                this.stage.addChild(line);
                line.graphics.setStrokeStyle(1).beginStroke("rgba(0, 0, 0, 0.5)")

                var start_x = this.padding_x + this.resolution * col;
                var start_y = this.padding_y;
                line.graphics.moveTo(start_x, start_y);

                var end_x = start_x;
                var end_y = this.padding_y + this.height;
                line.graphics.lineTo(end_x, end_y);
                line.graphics.endStroke();
            }

            // draw start point
            var start = new createjs.Shape();
            start.graphics.beginFill("rgba(127, 127, 127, 0.75)").drawCircle(0, 0, this.resolution * 0.5 - 1);
            start.x = this.padding_x + this.resolution * 0.5;
            start.y = this.padding_y + this.resolution * 0.5;
            this.stage.addChild(start);

            // draw destination point
            var dest = new createjs.Shape();
            dest.graphics.beginFill("DeepSkyBlue").drawCircle(0, 0, this.resolution * 0.5 - 1);
            dest.x = this.padding_x + this.width - this.resolution * 0.5;
            dest.y = this.padding_y + this.height - this.resolution * 0.5;
            this.stage.addChild(dest);
        }

        add_barrier(grid_x, grid_y) {
            var barrier = new Barrier(grid_x, grid_y);
            this.barriers.push(barrier);
            this.stage.addChild(barrier.shape);
        }

        add_laser_gun(grid_x, grid_y) {
            var laser_gun = new LaserGun(grid_x, grid_y);
            this.weapons.push(laser_gun);
            this.stage.addChild(laser_gun.shape);
        }

        add_monster(grid_x, grid_y) {
            var monster = new Monster(grid_x, grid_y, this.x_n_grids - 1, this.y_n_grids - 1, this);
            this.monsters.push(monster);
            this.stage.addChild(monster.shape);
        }

        is_grid_occupied(px, py) {
            var grid = pixel_to_grid(px, py);
            for (var i = 0; i < this.barriers.length; ++i) {
                var barrier = this.barriers[i];
                if (grid.x == barrier.gx && grid.y == barrier.gy) {
                    return true;
                }
            }

            for (var i = 0; i < this.weapons.length; ++i) {
                var weapon = this.weapons[i];
                if (grid.x == weapon.gx && grid.y == weapon.gy) {
                    return true;
                }
            }

            return false;
        }

        update() {
            for (var i = 0; i < this.monsters.length; ++i) {
                var monster = this.monsters[i];
                monster.move();
            }

            this.stage.update();
        }
    }

    function process_inputs() {
        // TODO: react to user's inputs, like click, move, etc
    }

    function init() {
        console.log("Hello World");
        var stage = new createjs.Stage("main_stage");

        map = new GridMap(stage)
        map.add_barrier(1, 0);
        map.add_laser_gun(3, 4);
        map.add_monster(3, 5);

        setInterval(function () {
            process_inputs();
            map.update();
        }, 40);
    }
</script>

</html>